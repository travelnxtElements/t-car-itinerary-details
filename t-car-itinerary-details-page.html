<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-policy/t-policy.html">
<link rel="import" href="../t-image/t-image.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-car-result-item/t-car-result-item.html" />
<link rel="import" href="t-shopping-cart-remove-all-api.html">
<link rel="import" href="t-shopping-cart-add-item-api.html">
<link rel="import" href="t-car-itinerary-details.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html"/>

<!--
    <h3>Details:</h3>

        `t-car-itinerary-details-page` displays details of selected car to be booked.

        It uses following child components in it -
            1. `t-notify`
            2. `t-header`
            3. `t-policy`
            4. `t-shopping-cart-remove-all-api`
            5. `t-shopping-cart-add-item-api`
            6. `t-faredetails`
            7. `t-car-itinerary-details`
            8. `t-button`
            9. `t-sessionstorage`

    <h3>Observers:</h3>

            1. '_visibleChange(visible)',
            2. '_addItemToCart(authToken, itineraryId, searchId)'

    <h3>Events:</h3>

        following events are fired by this component

            1. 'pricing-success' - fired when reviewed itinerary is selected for booking.
            3. `go-to-search` - fired when page is loaded without required page data.

    <h3>Example:</h3>

        <t-car-itinerary-details-page
            id="carDetails"
            api-base-url="[[apiBaseUrl]]"
            auth-token="[[authToken]]"
            api-url-format="[[apiUrlFormat]]"
            search-criteria="[[searchCriteria]]"
            search-id="[[searchId]]"
            car-icon="[[carIcon]]"
            itinerary="{{selectedItinerary}}"
            itinerary-id="[[itineraryId]]"
            on-pricing-success="_goToPassengerInfo">
            <t-header icon="bgv:arrow-left" normal-heading label="Review Itinerary"  url="[[siteUrl]]car/results">
                <t-car-search-recap data="[[searchCriteria]]"></t-car-search-recap>
            </t-header>
        </t-car-itinerary-details-page>

    @demo demo/index.html
-->

<dom-module id="t-car-itinerary-details-page">

    <template>
        <style include="iron-flex"></style>
        <style include="travel-element-styles">
            :host {
                display: block;
            }

            #btnContinue{
                display: block;
                margin: var(--normal-spacing,10px);
            }
        </style>

        <content select="t-header"></content>

        <t-notify id="notify"></t-notify>

        <t-policy id="policy"
            external-link
            label="Policies"
            api-relative-url="api/ShoppingCart/add"
            api-base-url="[[apiBaseUrl]]"
            auth-token="[[authToken]]"
            search-id="[[searchId]]"
            inventory-id="[[itineraryId]]"
            is-data-provided-by-view>
        </t-policy>

        <t-shopping-cart-remove-all-api
            id="removeCartItemApi" 
            loading={{loading}} 
            api-base-url="[[apiBaseUrl]]" 
            api-relative-url="api/ShoppingCart/remove/all" 
            auth-token="[[authToken]]"
            on-t-shopping-cart-remove-all-api-success="onRemoveCartSuccess"
            on-t-shopping-cart-remove-all-api-error="onRemoveCartError">
        </t-shopping-cart-remove-all-api>

        <t-shopping-cart-add-item-api
            id="addCartApi" 
            loading={{loading}} 
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/ShoppingCart/add" 
            auth-token="[[authToken]]"
            on-t-shopping-cart-add-item-api-success="onAddCartSuccess"
            on-t-shopping-cart-add-item-api-error="onAddCartError">
        </t-shopping-cart-add-item-api>

        <t-car-itinerary-details car-icon="[[carIcon]]" id="itineraryView"></t-car-itinerary-details>

        <t-faredetails 
          id="fareDetails"
          is-collapsible
          itinerary-fare-label="Car Rental">
        </t-faredetails>

        <t-button id="btnContinue" class="primary flex" label="continue" on-tap="onBtnContinueClick"></t-button>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Result_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>

    <script>
        (function () {

            'use strict'

            Polymer({

                is: 't-car-itinerary-details-page',

                behaviors: [
                      TravelNxt.Behaviors.DateBehavior
                ],

                properties: {

                    /*
                     * This string is query string containing token value
                     */
                    authToken: {
                        type: String
                    },

                    /*
                     * This property holds the value of api base URL
                     */
                    apiBaseUrl: {
                        type: String
                    },

                    /*
                     * This property holds the value of web api URL format
                     */
                    apiUrlFormat: {
                        type: String
                    },

                    /*
                     * This property holds the value of selected car itinerary
                     */
                    itinerary: {
                        type: Object,
                        notify: true
                    },

                    /*
                     * This property holds the value of selected itinerary id
                     */
                    itineraryId: {
                        type: String,
                        notify: true
                    },

                    /*
                     * This property holds the value of search criteria
                     */
                    searchCriteria: {
                        type: Object
                    },


                    /*
                     * This is a notification flag to indicate current page state
                     * Set it to true if page needs to be displayed on browser
                    */
                    visible: {
                        type: Boolean,
                        value: false,
                        notify: true
                    }
                },

                observers: [
                    '_visibleChange(visible)',
                    '_addItemToCart(authToken, itineraryId, searchId)'
                ],

                listeners: {
                    'policy-click': '_initiatePolicyCall'
                },

                /*
                 * event handler to reset policy view
                */
                _initiatePolicyCall: function (event) {
                    this.$.policy.initiatePolicyCall();
                },

                /*
                 * observer function for page `visible` property
                */
                _visibleChange: function (visible) {
                    if (visible && (!this.itineraryId || !this.searchId || !this.authToken || !this.searchCriteria)) {
                        this.fire('go-to-search');
                    }

                    //initiate policy component
                    this.$.policy.initiatePolicyView();
                },

                /*
                 * observer function for page `authToken`, `itineraryId`, `searchId` property
                */
                _addItemToCart: function (authToken, itineraryId, searchId) {
                    if (!itineraryId || !searchId || !authToken || !this.searchCriteria) {
                        return;
                    }

                    this.$.fareDetails.data = null;
                    this.$.fareDetails.$.loaderContainer.hidden = false;
                    this.$.fareDetails.error = false;

                    this.$.policy.policies = null;

                    this.$.btnContinue.disabled = true;

                    this.$.itineraryView.setDetails(this.itinerary, this.searchCriteria);

                    this.$.removeCartItemApi.remove();
                },

                /*
                 * success callback handler for `t-shopping-cart-remove-all-api` component
                */
                onRemoveCartSuccess: function (e) {
                    this.$.addCartApi.add(this._buildAddCartRequest());
                },

                /*
                 * builds request for add to cart api call
                */
                _buildAddCartRequest: function () {

                    //this is translator part, we can move it to translator
                    //kept it here because translation is simple

                    return {
                        itemInfos: [{
                            searchId: this.searchId,
                            inventoryId: this.itinerary.id
                        }]
                    }
                },

                /*
                 * error callback handler for `t-shopping-cart-remove-all-api` component
                */
                onRemoveCartError: function (e) {
                    this.$.fareDetails.error = true;
                    this.$.policy.onPolicyError();
                },

                /*
                 * success callback handler for `t-shopping-cart-add-item-api` component
                */
                onAddCartSuccess: function (e) {
                    if (!e.detail.addToCartItemResult || !e.detail.addToCartItemResult.length) {
                        this.$.fareDetails.error = true;
                        throw Error('failed to add itinerary in the cart!');
                    }

                    var addToCartItem = e.detail.addToCartItemResult[0];

                    this.itinerary = addToCartItem.inventory;

                    //set policies
                    this.$.policy.policies = this.itinerary.generalPolicies;

                    this.$.sessionStore.value = this.itinerary;

                    this.$.sessionStore.save();

                    if (addToCartItem.inventory) {
                        this.$.itineraryView.itinerary = addToCartItem.inventory;
                        this._setFareDetails();
                    }

                    this.$.btnContinue.disabled = false;
                },

                /*
                 * error callback handler for `t-shopping-cart-add-item-api` component
                */
                onAddCartError: function (e) {
                    this.$.fareDetails.error = true;
                    this.$.policy.onPolicyError();
                },

                /*
                 * continue button tap event handler
                */
                onBtnContinueClick: function () {
                    if (this.$.btnContinue.disabled) {
                        return;
                    }
                    this.fire('pricing-success');
                },

                /*
                 * translator method to set view components data
                */
                _setFareDetails: function () {
                    if (!this.itinerary || !this.searchCriteria) {
                        return;
                    }

                    this.$.fareDetails.baseFareLabel = 'Avg. per day rate x ' + this._dateDiff(this.searchCriteria.pickupDate, this.searchCriteria.dropoffDate);

                    if (this.itinerary.fare && this.itinerary.fare.components) {
                        this.$.fareDetails.data = this.itinerary.fare.components;
                    }
                },

                /*
                 * `t-sessionstorage` load success callback handler
                */
                onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.itinerary = this.$.sessionStore.value.itinerary;
                    }
                }
            });

        })();
    </script>
</dom-module>
