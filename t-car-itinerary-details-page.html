<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="t-shopping-cart-remove-all-api.html">
<link rel="import" href="t-shopping-cart-add-item-api.html">
<link rel="import" href="t-car-itinerary-details.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-itinerary-details-page">
    <template>
        <style>
        :host {
            display: block;
        }
        t-button{
            display: block;
            margin: 10px;
        }
        </style>

        <content select="t-header"></content>

        <t-notify id="notify"></t-notify>

        <t-shopping-cart-remove-all-api
            id="removeCartItemApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" 
            api-relative-url="api/ShoppingCart/remove/all" 
            auth-token="{{authToken}}"
            on-t-shopping-cart-remove-all-api-success="onRemoveCartSuccess"
            on-t-shopping-cart-remove-all-api-error="onRemoveCartError">
        </t-shopping-cart-remove-all-api>

        <t-shopping-cart-add-item-api
            id="addCartApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" s
            api-relative-url="api/ShoppingCart/add" 
            auth-token="{{authToken}}"
            on-t-shopping-cart-add-item-api-success="onAddCartSuccess"
            on-t-shopping-cart-add-item-api-error="onAddCartError">
        </t-shopping-cart-add-item-api>

        <t-car-itinerary-details id="itineraryView">
        </t-car-itinerary-details>

        <t-faredetails 
          id="fareDetails"
          is-collapsible
          itinerary-fare-label="Car Rental">
        </t-faredetails>

        <t-button id="btnContinue" label="continue" on-tap="onBtnContinueClick"></t-button>

    </template>
    <script>
    Polymer({
        is: 't-car-itinerary-details-page',

        observers : [
            '_addItemToCart(itinerary, searchCriteria, visible)'
        ],

        behaviors: [
              TravelNxt.Behaviors.DateBehavior
        ],

        properties: {

            /*
             * <p>This string is query string containing token value</p>
             */
            authToken: {
                type: String
            },

            /*
             * <p>This property holds the value of api base URL</p>
             */
            apiBaseUrl: {
                type: String
            },

            /*
             * <p>This property holds the value of web api URL format</p>
             */
            apiUrlFormat: {
                type: String
            },

            itinerary: {
                type: Object,
                notify: true
            },

            searchCriteria: {
                type: Object,
                value: null
            },

            visible: {
                type: Boolean,
                value: false,
                notify: true
            },

            queryParams: {
                type: Object,
                notify: true
            }
        },

        _addItemToCart: function (itinerary, searchCriteria, visible) {
            if (!itinerary || !this.queryParams.searchId || !searchCriteria || !visible) {
                return;
            }

            this.$.btnContinue.disabled = true;

            if (itinerary.fare) {
                itinerary.fare = null;
            }

            this.$.itineraryView.itinerary = itinerary;
            this.$.itineraryView.searchCriteria = searchCriteria;

            this.$.removeCartItemApi.remove();
        },

        _getItinerarySchedule: function () {
            
        },

        onRemoveCartSuccess: function (e) {
            this.$.addCartApi.add({
                searchId: this.queryParams.searchId,
                itineraryId: this.itinerary.id
            });         
        },

        onRemoveCartError: function (e) {
            
        },

        onAddCartSuccess: function (e) {
            if (!e.detail.addToCartItemResult || !e.detail.addToCartItemResult.length) {
                throw Error('failed to add itinerary in the cart!');
            }

            var addToCartItem = e.detail.addToCartItemResult[0];

            if (addToCartItem.inventory) {
                this.$.itineraryView.itinerary = addToCartItem.inventory;
                this.itinerary.fare = addToCartItem.inventory.fare;
                this._setFareDetails();
            }

            this.$.btnContinue.disabled = false;
        },

        onAddCartError: function (e) {
                
        },

        onBtnContinueClick: function () {
            if (this.$.btnContinue.disabled) {
                return;
            }
            this.fire('pricing-success');
        },

        _setFareDetails: function () {
            if (!this.itinerary || !this.searchCriteria) {
                return;
            }

            var formattedDate = this._getDateComponents(this.searchCriteria.pickupDate);
            this.pickupDate = formattedDate.date + ' ' + formattedDate.shortMonth + ' ' + this.searchCriteria.pickupTime;

            formattedDate = this._getDateComponents(this.searchCriteria.dropoffDate);
            this.dropoffDate = formattedDate.date + ' ' + formattedDate.shortMonth + ' ' + this.searchCriteria.dropoffTime;

            this.$.fareDetails.baseFareLabel = 'Avg. per day rate x ' + this._dateDiff(this.pickupDate, this.dropoffDate);

            if (this.itinerary.fare && this.itinerary.fare.components) {
                this.$.fareDetails.data = this.itinerary.fare.components;
            }
        }
    });
    </script>
</dom-module>
