<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="t-shopping-cart-remove-all-api.html">
<link rel="import" href="t-shopping-cart-add-item-api.html">
<link rel="import" href="t-car-itinerary-details.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-itinerary-details-page">
    <template>
        <style>
        :host {
            display: block;
        }
        t-button{
            display: block;
            margin: 10px;
        }
        </style>

        <content select="t-header"></content>

        <t-notify id="notify"></t-notify>

        <t-shopping-cart-remove-all-api
            id="removeCartItemApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" 
            api-relative-url="api/ShoppingCart/remove/all" 
            auth-token="{{authToken}}"
            on-t-shopping-cart-remove-all-api-success="onRemoveCartSuccess"
            on-t-shopping-cart-remove-all-api-error="onRemoveCartError">
        </t-shopping-cart-remove-all-api>

        <t-shopping-cart-add-item-api
            id="addCartApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" s
            api-relative-url="api/ShoppingCart/add" 
            auth-token="{{authToken}}"
            on-t-shopping-cart-add-item-api-success="onAddCartSuccess"
            on-t-shopping-cart-add-item-api-error="onAddCartError">
        </t-shopping-cart-add-item-api>

        <t-car-itinerary-details id="itineraryView"></t-car-itinerary-details>

        <t-faredetails 
          id="fareDetails"
          is-collapsible
          itinerary-fare-label="Car Rental">
        </t-faredetails>

        <t-button id="btnContinue" label="continue" on-tap="onBtnContinueClick"></t-button>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Result_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>
<script>
    Polymer({
        is: 't-car-itinerary-details-page',

        observers: [
            '_addItemToCart(itinerary, visible)'
        ],

        behaviors: [
              TravelNxt.Behaviors.DateBehavior
        ],

        properties: {

            /*
             * <p>This string is query string containing token value</p>
             */
            authToken: {
                type: String
            },

            /*
             * <p>This property holds the value of api base URL</p>
             */
            apiBaseUrl: {
                type: String
            },

            /*
             * <p>This property holds the value of web api URL format</p>
             */
            apiUrlFormat: {
                type: String
            },

            itinerary: {
                type: Object,
                notify: true
            },

            searchCriteria: {
                type: Object
            },

            visible: {
                type: Boolean,
                value: false,
                notify: true,
                observer: '_updateIsLoaded'
            },

            isLoaded: {
                type: Boolean,
                value: false,
                readOnly: true
            }
        },

        _addItemToCart: function (itinerary, visible) {
            if (!itinerary || this.isLoaded || !this.searchId || !this.searchCriteria || !visible) {
                return;
            }

            this.$.fareDetails.data = null;

            this.$.btnContinue.disabled = true;

            if (this.itinerary.fare) {
                this.itinerary.fare = null;
            }

            this.$.itineraryView.setDetails(this.itinerary, this.searchCriteria);

            this.$.removeCartItemApi.remove();
        },

        _getItinerarySchedule: function() {

        },

        onRemoveCartSuccess: function(e) {
            this.$.addCartApi.add({
                searchId: this.searchId,
                itineraryId: this.itinerary.id
            });
        },

        onRemoveCartError: function(e) {

        },

        onAddCartSuccess: function(e) {
            if (!e.detail.addToCartItemResult || !e.detail.addToCartItemResult.length) {
                throw Error('failed to add itinerary in the cart!');
            }

            var addToCartItem = e.detail.addToCartItemResult[0];

            this._setIsLoaded(true);

            this.itinerary = addToCartItem.inventory;
            
            this.$.sessionStore.value = this.itinerary;
            this.$.sessionStore.save();

            if (addToCartItem.inventory) {
                this.$.itineraryView.itinerary = addToCartItem.inventory;
                this.itinerary = addToCartItem.inventory;
                this._setFareDetails();
            }

            this.$.btnContinue.disabled = false;
        },

        onAddCartError: function(e) {

        },

        onBtnContinueClick: function() {
            if (this.$.btnContinue.disabled) {
                return;
            }
            this.fire('pricing-success');
        },

        _setFareDetails: function () {
            if (!this.itinerary || !this.searchCriteria) {
                return;
            }

            this.$.fareDetails.baseFareLabel = 'Avg. per day rate x ' + this._dateDiff(this.pickupDate, this.dropoffDate);

            if (this.itinerary.fare && this.itinerary.fare.components) {
                this.$.fareDetails.data = this.itinerary.fare.components;
            }
        },

        _updateIsLoaded: function (a, b) {
            if (!this.visible && this.isLoaded === true) {
                this._setIsLoaded(false);
            }
        },

        onSessionLoad: function () {
            if (this.$.sessionStore.value) {
                this.itinerary = this.$.sessionStore.value.itinerary;
            }
        }
    });
</script>

</dom-module>
